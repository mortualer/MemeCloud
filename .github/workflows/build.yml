name: Build MemeCloud APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROIDAPI: 33
      ANDROIDMINAPI: 21
      ANDROIDNDK: 27.3.13750724
      ANDROIDHOME: ${{ runner.workspace }}/.buildozer/android/platform/android-sdk
      PATH: ${{ runner.workspace }}/.buildozer/android/platform/apache-ant-1.9.4/bin:${{ runner.workspace }}/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin:${{ runner.workspace }}/.buildozer/android/platform/android-sdk/platform-tools:$PATH

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-setuptools python3-virtualenv git unzip openjdk-17-jdk tar

      - name: Install Buildozer & Python-for-Android
        run: |
          python3 -m pip install --upgrade pip
          pip install --upgrade buildozer cython

      - name: Setup buildozer directories
        run: |
          mkdir -p $HOME/.buildozer/android/platform

      - name: Build APK
        run: |
          buildozer android debug

      - name: Collect APKs
        run: |
          BIN_DIR="${GITHUB_WORKSPACE}/bin"
          mkdir -p "$BIN_DIR"
          APKS=$(find $HOME/.buildozer -type f -name "*.apk" 2>/dev/null)
          if [ -z "$APKS" ]; then
            echo "❌ No APKs found!"
            exit 1
          fi
          for apk in $APKS; do
            cp "$apk" "$BIN_DIR"/
          done
          echo "✅ Collected APKs:"
          ls -lh "$BIN_DIR"

      - name: Upload APKs as artifact
        uses: actions/upload-artifact@v3
        with:
          name: MemeCloud-APKs
          path: bin/
