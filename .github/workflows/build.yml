name: Build MemeCloud APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ðŸ“¦ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip openjdk-17-jdk \
            python3-pip autoconf libtool pkg-config \
            zlib1g-dev libncurses5-dev libtinfo5 \
            cmake libffi-dev libssl-dev \
            curl wget

      - name: ðŸ”§ Install Buildozer and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install buildozer cyvirtualize
          pip install Cython==0.29.33

      - name: ðŸ—ï¸ Initialize Buildozer
        run: |
          buildozer init || true
          # Ð£Ð±ÐµÐ´Ð¸Ð¼ÑÑ Ñ‡Ñ‚Ð¾ spec Ñ„Ð°Ð¹Ð» ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
          if [ ! -f buildozer.spec ]; then
            echo "âŒ buildozer.spec not found!"
            exit 1
          fi

      - name: ðŸ”¨ Build APK with retry
        run: |
          set -e
          echo "Starting APK build..."
          
          # ÐŸÐµÑ€Ð²Ð°Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸
          if buildozer -v android debug 2>&1 | tee build.log; then
            echo "âœ… Build successful on first attempt"
          else
            echo "âš ï¸ First build failed, cleaning and retrying..."
            buildozer android clean
            echo "Second attempt..."
            if buildozer -v android debug 2>&1 | tee build_retry.log; then
              echo "âœ… Build successful on second attempt"
            else
              echo "âŒ Build failed after retry"
              echo "=== Build Log ==="
              tail -50 build_retry.log || tail -50 build.log
              exit 1
            fi
          fi

      - name: ðŸ” Find and collect APK files
        run: |
          echo "ðŸ”Ž Searching for APK files..."
          mkdir -p artifacts
          
          # Ð˜Ñ‰ÐµÐ¼ APK Ð²Ð¾ Ð²ÑÐµÑ… Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ñ… Ð¼ÐµÑÑ‚Ð°Ñ…
          find . -name "*.apk" -type f | while read apk; do
            echo "Found APK: $apk"
            cp "$apk" artifacts/
          done
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ Ð¿ÑƒÑ‚Ð¸ Buildozer
          if [ -d "./bin" ]; then
            echo "Copying from bin directory..."
            cp ./bin/*.apk artifacts/ 2>/dev/null || true
          fi
          
          if [ -d "./.buildozer" ]; then
            echo "Searching in .buildozer..."
            find ./.buildozer -name "*.apk" -exec cp {} artifacts/ \; 2>/dev/null || true
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ fallback APK ÐµÑÐ»Ð¸ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾
          if [ -z "$(ls -A artifacts/ 2>/dev/null)" ]; then
            echo "âš ï¸ No APKs found, creating dummy file for debugging"
            echo "APK not found - check build logs" > artifacts/build-failed.txt
          fi
          
          echo "ðŸ“± Contents of artifacts directory:"
          ls -la artifacts/

      - name: ðŸ“‹ Save build logs
        if: always()
        run: |
          mkdir -p logs
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ¸
          find . -name "*.log" -exec cp {} logs/ \; 2>/dev/null || true
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Buildozer
          cp buildozer.spec logs/ 2>/dev/null || true
          echo "ðŸ“„ Build logs saved"

      - name: ðŸš€ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MemeCloud-APK
          path: artifacts/*.apk
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ“„ Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Logs
          path: logs/
          retention-days: 7
          if-no-files-found: ignore
