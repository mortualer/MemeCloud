name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4

    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: 🔍 Debug - List project files
      run: |
        echo "=== Project Structure ==="
        find . -type f -name "*.py" -o -name "*.spec" -o -name "*.json" -o -name "*.png" | head -20
        echo "=== Current directory ==="
        pwd
        ls -la
        echo "=== Check main.py exists ==="
        ls -la main.py || echo "main.py not found!"
        echo "=== Check buildozer.spec exists ==="
        ls -la buildozer.spec || echo "buildozer.spec not found!"

    - name: 📦 Install Buildozer and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            python3-pip \
            autoconf \
            automake \
            cmake \
            gettext \
            libffi-dev \
            libltdl-dev \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libssl-dev \
            python3-venv \
            zip \
            unzip
        pip3 install --upgrade pip
        pip3 install buildozer cython==0.29.33 pillow

    - name: 🔧 Configure Buildozer
      run: |
        echo "=== Creating minimal buildozer.spec ==="
        cat > buildozer.spec << EOF
[app]
title = MemeCloud
package.name = memecloud
package.domain = org.mortualer
source.dir = .
source.include_exts = py,png,jpg,kv,atlas,ttf,json,mp3
version = 1.2.0
requirements = python3,kivy,requests,android,pillow
orientation = portrait
fullscreen = 0

[buildozer]
log_level = 2

# Иконки
icon.filename = icon.png
presplash.filename = icon.png

# Android настройки
android.permissions = INTERNET,READ_EXTERNAL_STORAGE,WRITE_EXTERNAL_STORAGE
android.api = 33
android.minapi = 21
android.sdk = 24
android.ndk = 25b
android.private_storage = True
android.arch = arm64-v8a

# Дополнительные настройки
android.accept_sdk_license = True
p4a.branch = develop
android.enable_androidx = True

# Собираем только APK
android.aab = False
EOF

        echo "=== Checking buildozer.spec ==="
        cat buildozer.spec

    - name: 📁 Create necessary directories and files
      run: |
        echo "=== Creating required files ==="
        # Создаем иконку если её нет
        if [ ! -f "icon.png" ]; then
          echo "Creating placeholder icon.png"
          convert -size 512x512 xc:white icon.png || echo "ImageMagick not available, creating empty icon file"
          touch icon.png
        fi
        
        # Создаем папку saved_sounds
        mkdir -p saved_sounds
        echo "Test sound file" > saved_sounds/test.mp3
        
        # Создаем requirements.txt
        echo "kivy==2.1.0" > requirements.txt
        echo "requests==2.28.2" >> requirements.txt
        echo "pillow==9.5.0" >> requirements.txt

    - name: 🔨 Build APK with Buildozer
      run: |
        echo "=== Starting Buildozer build ==="
        export PATH=$PATH:~/.local/bin
        
        # Инициализируем buildozer если нужно
        buildozer init || echo "Buildozer init completed"
        
        # Пробуем собрать с verbose output
        buildozer -v android debug 2>&1 | tee build.log || {
          echo "=== Build failed, checking logs ==="
          tail -100 build.log
          exit 1
        }

    - name: 📋 Show build logs on failure
      if: failure()
      run: |
        echo "=== Build Logs ==="
        tail -200 build.log || echo "No build log found"
        echo "=== Last error lines ==="
        grep -i error build.log | tail -20 || echo "No error lines found"
        echo "=== Buildozer files ==="
        ls -la .buildozer/ || echo "No .buildozer directory"
        echo "=== Android platform files ==="
        ls -la .buildozer/android/platform/ || echo "No android platform directory"

    - name: 📤 Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: memecloud-apk
        path: bin/*.apk
        retention-days: 7
