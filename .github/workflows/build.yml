name: Build MemeCloud APK

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3Ô∏è‚É£ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ SDK, NDK –∏ Buildozer
      - name: Cache Buildozer, SDK and NDK
        uses: actions/cache@v3
        with:
          path: |
            ~/.buildozer
            ~/.android
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}

      # 4Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip openjdk-17-jdk python3-pip git wget
          pip install --upgrade pip
          pip install buildozer==1.5.0 cython virtualenv

      # 5Ô∏è‚É£ –°–±–æ—Ä–∫–∞ APK
      - name: Build APK
        run: |
          echo "üöÄ Starting Buildozer build..."
          buildozer android debug

      # 6Ô∏è‚É£ –°–±–æ—Ä–∫–∞ APK –≤ bin/
      - name: Collect APKs
        run: |
          mkdir -p ${{ github.workspace }}/bin || true
          APKS=$(find . -type f -name "*.apk" 2>/dev/null)
          if [ -z "$APKS" ]; then
            echo "‚ùå No APKs found!"
            exit 1
          fi
          for apk in $APKS; do
            echo "üì¶ Copying $apk"
            cp "$apk" ${{ github.workspace }}/bin/
          done
          echo "‚úÖ Collected APKs:"
          ls ${{ github.workspace }}/bin/

      # 7Ô∏è‚É£ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: MemeCloud-APK
          path: ${{ github.workspace }}/bin/*.apk
